services:
  dealership-web:
    build: .
    container_name: ${DOCKER_CONTAINER_NAME}-web
    depends_on:
      - dealership-db
    restart: always
    environment:
      # Database
      DB_CONNECTION: pgsql
      DB_HOST: dealership-db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # App
      APP_NAME: ${APP_NAME}
      APP_ENV: ${APP_ENV}
      APP_KEY: ${APP_KEY}
      APP_DEBUG: ${APP_DEBUG}
      APP_URL: ${APP_URL}
      APP_TIMEZONE: ${APP_TIMEZONE}
      # Seeding (set to true to run seeders on startup)
      SEED_DATABASE: ${SEED_DATABASE:-false}
      # Nginx Proxy (only used on server)
      VIRTUAL_HOST: ${DOCKER_CONTAINER_NAME}-${ENVIRONMENT}.${BASE_DOMAIN}
      LETSENCRYPT_HOST: ${DOCKER_CONTAINER_NAME}-${ENVIRONMENT}.${BASE_DOMAIN}
      VIRTUAL_PORT: 80
    env_file:
      - .env
    volumes:
      - ./:/var/www/html
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    mem_limit: 512M
    tty: true
    ports:
      - "${DOCKER_LARAVEL_PORT}:80"
    networks:
      - proxy-network

  dealership-db:
    image: postgres:18
    container_name: ${DOCKER_CONTAINER_NAME}-db
    restart: always
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    env_file:
      - .env
    volumes:
      - dealership-db-data:/var/lib/postgresql/data
    ports:
      - "${DOCKER_POSTGRES_PORT}:5432"
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      interval: 10s
      timeout: 5s
      retries: 5

  dealership-adminer:
    image: adminer:latest
    container_name: ${DOCKER_CONTAINER_NAME}-adminer
    depends_on:
      - dealership-db
    restart: always
    environment:
      ADMINER_DEFAULT_SERVER: dealership-db
      ADMINER_DESIGN: nette
      VIRTUAL_HOST: ${DOCKER_CONTAINER_NAME}-adminer-${ENVIRONMENT}.${BASE_DOMAIN}
      LETSENCRYPT_HOST: ${DOCKER_CONTAINER_NAME}-adminer-${ENVIRONMENT}.${BASE_DOMAIN}
      VIRTUAL_PORT: 8080
    ports:
      - "${DOCKER_ADMINER_PORT}:8080"
    networks:
      - proxy-network

volumes:
  dealership-db-data:

networks:
  proxy-network:
    external: true
