name: actuallyfind-production

services:
  # ----------------------------------------------
  # BLUE SERVICE SLOT (New Deployments start here if LIVE is GREEN)
  # ----------------------------------------------
  actuallyfind-web-blue:
    image: ghcr.io/monatemedia/dealership:${IMAGE_TAG:-production} # Pulled image
    container_name: actuallyfind-web-blue
    depends_on:
      actuallyfind-db:
        condition: service_healthy
      actuallyfind-typesense:
        condition: service_started
    restart: always
    entrypoint: /usr/local/bin/docker-entrypoint.sh
    command: apache2-foreground
    environment:
      # Database variables for Larvel (Pulled from shell interpolation)
      DB_CONNECTION: pgsql
      DB_HOST: actuallyfind-db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # App (Required for Apache/Env setup)
      APP_URL: ${APP_URL}
      VIRTUAL_HOST: ${VIRTUAL_HOST_SET}
      LETSENCRYPT_HOST: ${VIRTUAL_HOST_SET}
      VIRTUAL_PORT: 80
    env_file:
      - .env
    volumes:
      - ./.env:/var/www/html/.env
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
    mem_limit: 512M
    tty: true
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ----------------------------------------------
  # GREEN SERVICE SLOT
  # ----------------------------------------------
  actuallyfind-web-green:
    image: ghcr.io/monatemedia/dealership:${IMAGE_TAG:-production} # Pulled image
    container_name: actuallyfind-web-green
    depends_on:
      actuallyfind-db:
        condition: service_healthy
      actuallyfind-typesense:
        condition: service_started
    restart: always
    entrypoint: /usr/local/bin/docker-entrypoint.sh
    command: apache2-foreground
    environment:
      # Database variables for Larvel (Pulled from shell interpolation)
      DB_CONNECTION: pgsql
      DB_HOST: actuallyfind-db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # App (Required for Apache/Env setup)
      APP_URL: ${APP_URL}
      VIRTUAL_HOST: ${VIRTUAL_HOST_SET}
      LETSENCRYPT_HOST: ${VIRTUAL_HOST_SET}
      VIRTUAL_PORT: 80
    env_file:
      - ./.env
    volumes:
      - ./.env:/var/www/html/.env
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
    mem_limit: 512M
    tty: true
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ----------------------------------------------
  # SHARED SERVICES
  # ----------------------------------------------
  actuallyfind-queue:
    image: ghcr.io/monatemedia/dealership:${IMAGE_TAG:-production}
    container_name: actuallyfind-queue
    depends_on:
      actuallyfind-db:
        condition: service_healthy
      actuallyfind-typesense:
        condition: service_started
    restart: always
    # Use the same entrypoint as the web app to run migrations/setup
    entrypoint: /usr/local/bin/docker-entrypoint.sh
    # OVERRIDE the command to start the worker instead of Apache
    command: php artisan queue:work --verbose --tries=3 --timeout=300
    environment:
      DB_CONNECTION: pgsql
      DB_HOST: actuallyfind-db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
    env_file:
      - .env
    volumes:
      - ./.env:/var/www/html/.env
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
    mem_limit: 512M
    networks:
      - proxy-network

  actuallyfind-typesense:
    image: typesense/typesense:29.0
    container_name: actuallyfind-typesense
    restart: always
    command: '--data-dir /data --api-key=${TYPESENSE_API_KEY} --enable-cors'
    environment:
      TYPESENSE_API_KEY: ${TYPESENSE_API_KEY}
    volumes:
      - actuallyfind-typesense-data:/data
    ports:
      - "${DOCKER_TYPESENSE_PORT:-8108}:8108"
    networks:
      - proxy-network
    healthcheck:
      # Check if the port is open using the standard 'sh' shell
      test: ["CMD-SHELL", "/usr/bin/test -f /opt/typesense-server || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

  actuallyfind-db:
    image: postgis/postgis:18-3.6-alpine
    container_name: actuallyfind-db
    restart: always
    environment:
      POSTGRES_DB: actuallyfind_db
      POSTGRES_USER: ACTUAL_PROD_DB_USER
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - actuallyfind-db-data:/var/lib/postgresql
    ports:
      - "${DOCKER_POSTGRES_PORT}:5432"
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  actuallyfind-db-data:
  actuallyfind-typesense-data:

networks:
  proxy-network:
    external: true
