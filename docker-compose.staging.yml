services:
  dealership-web:
    image: ghcr.io/monatemedia/${DOCKER_CONTAINER_NAME}:${IMAGE_TAG:-staging}
    container_name: ${DOCKER_CONTAINER_NAME}-web
    depends_on:
      dealership-db:
        condition: service_healthy
    restart: always
    entrypoint: /bin/bash -c "echo 'Waiting for database connection...'; until (exec 6<>/dev/tcp/dealership-db/5432) 2>/dev/null; do echo 'Database not ready, sleeping for 1 second...'; sleep 1; done; echo 'Database is ready. Executing application setup...'; /usr/local/bin/docker-entrypoint.sh"
    environment:
      # Database
      DB_CONNECTION: pgsql
      DB_HOST: dealership-db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # App
      APP_NAME: ${APP_NAME}
      APP_ENV: ${APP_ENV}
      APP_KEY: ${APP_KEY}
      APP_DEBUG: ${APP_DEBUG}
      APP_URL: ${APP_URL}
      APP_TIMEZONE: ${APP_TIMEZONE}
      # Seeding
      SEED_DATABASE: ${SEED_DATABASE:-false}
      # Nginx Proxy
      VIRTUAL_HOST: ${DOCKER_CONTAINER_NAME}.${BASE_DOMAIN}
      LETSENCRYPT_HOST: ${DOCKER_CONTAINER_NAME}.${BASE_DOMAIN}
      VIRTUAL_PORT: 80
    env_file:
      - .env
    volumes:
      - ./.env:/var/www/html/.env
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh
    mem_limit: 512M
    tty: true
    ports:
      - "${DOCKER_LARAVEL_PORT}:80"
    networks:
      - proxy-network

  dealership-queue:
    image: ghcr.io/monatemedia/dealership:${IMAGE_TAG:-staging-1.0.0}
    container_name: ${DOCKER_CONTAINER_NAME}-queue
    depends_on:
      dealership-db:
        condition: service_healthy
    restart: always
    entrypoint: /bin/bash -c "echo 'Waiting for database connection...'; until (exec 6<>/dev/tcp/dealership-db/5432) 2>/dev/null; do echo 'Database not ready, sleeping for 1 second...'; sleep 1; done; echo 'Database is ready. Starting queue worker...'; php artisan queue:work --verbose --tries=3 --timeout=300 --sleep=3 --max-jobs=1000"
    environment:
      # Database
      DB_CONNECTION: pgsql
      DB_HOST: dealership-db
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # App
      APP_NAME: ${APP_NAME}
      APP_ENV: ${APP_ENV}
      APP_KEY: ${APP_KEY}
      APP_DEBUG: ${APP_DEBUG}
      APP_URL: ${APP_URL}
      APP_TIMEZONE: ${APP_TIMEZONE}
    env_file:
      - .env
    volumes:
      - ./.env:/var/www/html/.env
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    mem_limit: 512M
    networks:
      - proxy-network

  dealership-typesense:
    image: typesense/typesense:29.0
    container_name: ${DOCKER_CONTAINER_NAME}-typesense
    restart: always
    command: '--data-dir /data --api-key=${TYPESENSE_API_KEY} --enable-cors'
    environment:
      TYPESENSE_API_KEY: ${TYPESENSE_API_KEY}
    volumes:
      - dealership-typesense-data:/data
    ports:
      - "${DOCKER_TYPESENSE_PORT:-8108}:8108"
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8108/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  dealership-db:
    image: postgres:18
    container_name: ${DOCKER_CONTAINER_NAME}-db
    restart: always
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    env_file:
      - .env
    volumes:
      - dealership-db-data:/var/lib/postgresql
    ports:
      - "${DOCKER_POSTGRES_PORT}:5432"
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      interval: 10s
      timeout: 5s
      retries: 5

  dealership-adminer:
    image: adminer:latest
    container_name: ${DOCKER_CONTAINER_NAME}-adminer
    depends_on:
      - dealership-db
    restart: always
    environment:
      ADMINER_DEFAULT_SERVER: dealership-db
      ADMINER_DESIGN: nette
      VIRTUAL_HOST: ${DOCKER_CONTAINER_NAME}-adminer.${BASE_DOMAIN}
      LETSENCRYPT_HOST: ${DOCKER_CONTAINER_NAME}-adminer.${BASE_DOMAIN}
      VIRTUAL_PORT: 8080
    ports:
      - "${DOCKER_ADMINER_PORT}:8080"
    networks:
      - proxy-network

volumes:
  dealership-db-data:

networks:
  proxy-network:
    external: true
